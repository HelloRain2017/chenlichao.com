---
layout: post
title: webim-nodejs-vs-eurasia
description: webim-nodejs-vs-eurasia
---

需要为一个1百万用户的线上应用(PHP的)提供WEB IM，
有人建议用 nodejs 做 server，它是单线程事件驱动的 server。
Google 时知道了 Eurasia，根据介绍知道了几个关键词：百万用户，长连接，Python，专为 Web IM，游戏而生。酷。
我现在想用 Eurasia 去实现这个应用，接触 Python 不久，有几个问题：
1.  Eurasia 与 Node.js 比较有什么优势？（优势一，我更喜欢 Python）
2.  必须要用 Statckless Python 才能达到百万用户同时在线的性能吗？
3.  如果聊天记录要存到 MongoDB，网络 IO 会是瓶颈吗？怎么解决比较好。
4.  这里所说的长连接是一直连接吗？还是只是超时时间更长？

http所谓的长连接本质上就是超时时间长，100W的活动TCP连接怕是很玄，
因为按照一个Connection 2M的内存消耗来看，100W的活动TCP连接光是内存都吃不消拉

虽然在没有做任何优化的情况下一个 python socket 占用的内存确实较多，
但好像并不会有 2M 这么多，4G 内存应该也可以达到百万句柄。这个测试做得比较久了，
已经记不大清了。 *但随着连接数的上升，内存压力会比较大。*

Python 服务器在运行过程中，确实会发生 *内存不断上升* 的现象，减去启动时的初始内存，
每个连接平均下来 2M 是完全可能的。除去一些预分配的情况，
更多时候是因为内存没有回收。

服务器中的 socket 对象是很容易发生 *循环引用* 等情况的， *引用计数* 就会失效，
所以对应用服务器来说这是一种比较常见的情况。 *垃圾回收GC开始工作后这些内存是会自动回收的。*

不过并发要求比较高的服务器，应该 *避免使用GC垃圾回收机制。*
比如 *在 eurasia 在编码中避免产生循环引用* 的情况，
*引用计数可以有效即时回收内存* ，因此情况就要好很多。

Alexander 提到的这点非常重要， *随着连接数的上升内存肯定会很快耗尽。*
同时 CPU 以及网络压力都是非常大的，到这个量级的程序和普通应用是有很大区别的。

我们在此类应用中，对 *单连接的内存内存占用* ，以及系统许多部分都是经过专门优化的。
这可能需要一定的专业知识和经验。

我没有深入了解过 node.js，只能简单提取一下 eurasia 和 node.js
它们之间一些表面上的区别。

1.  先 eurasia 是基于 python 的；而 node.js 是基于 javascript 的。
    然后 node.js 是异步模型；虽然 eurasia 底层一样是异步的，但你不需要关心事件、回调之类的异步逻辑，
    底层会自动处理。
    最后如果 node.js 是纯异步的话，并发和性能上与 eurasia 应在同一层次。

2.  eurasia 3.1 不依赖于 stackless python，eurasia 3.0 需要。

3.  阻塞式的数据库 IO 对异步服务器都会是瓶颈，对 eurasia 和 node.js 都是这样的。
    如果数据库有 *纯 python 实现的接口* ，eurasia 就可以直接使用而不会造成性能问题，
    否则就需要编写一定的 “驱动” 将阻塞式数据库接口异步化。
    详见 eurasia 文档数据库部分。
    当然在数十万的长连接情况下，最好避免有数据库 IO 产生。聊天记录比较接近日志文件的技术。

4.  这里说的长连接是一直连接的，和比较长的超时时间是一件事情。
    在 eurasia 中可以非常细粒度的控制超时，甚至对每一个读写操作进行超时控制。
    sock.read(1024, timeout=10.)
    sock.write('hello world!', timeout=15.)

其实我倒是很想问问沈大如何 *回避GIL充分利用多核计算能力* 来着?

目前简单的作法是多进程,用MQ 进行協同...

> 沈大能给个思路不呢，比如在多个Eurasia进程之间广播消息？

这个解决方案比较多，方案细节也比较多，说起来比较困难。其实就和进程间通信是一样的。
这里我试着给一个 quick and dirty 的办法，一下子也讲不清楚，也就提供点思路吧。
1.  有多个（eurasia）前端服务器 frontend
2.  创建一个广播服务器 broadcast

每个前端服务器启用一个“线程”（greenlet 协程）通过 socket 连接到广播服务器。
socket 将一直处于等待广播服务器返回信息的状态，一有信息来立即在本服务器内转发
然后继续等待下一条广播。

0mq
